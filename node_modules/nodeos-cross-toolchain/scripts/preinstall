#!/usr/bin/env bash

set -o pipefail


SOURCES=`pwd`/deps


# Dependencies versions

BINUTILS_VERSION=2.25.1
GCC_VERSION=4.7.3
LINUX_VERSION=4.2.3
MUSL_VERSION=1.1.11


# Dependencies URLs

BINUTILS_URL=http://ftpmirror.gnu.org/binutils/binutils-$BINUTILS_VERSION.tar.gz
GCC_URL=http://ftpmirror.gnu.org/gcc/gcc-$GCC_VERSION/gcc-$GCC_VERSION.tar.gz
LINUX_URL=https://www.kernel.org/pub/linux/kernel/v4.x/linux-$LINUX_VERSION.tar.gz
MUSL_URL=http://www.musl-libc.org/releases/musl-$MUSL_VERSION.tar.gz


# Clean download directory on failure to be able to continue from the same point

RED="\e[31m"
CLR="\e[0m"

function err(){
  echo -e "${RED}Error downloading '${URL}'${CLR}"
  rm -rf $SRC_DIR
  rmdir -p --ignore-fail-on-non-empty `dirname $SRC_DIR`
  exit $1
}


#
# binutils
#

URL=$BINUTILS_URL
SRC_DIR=$SOURCES/binutils
if [[ ! -d $SRC_DIR ]]; then
  mkdir -p $SRC_DIR                                         &&
  curl -L $URL | tar xzf - -C $SRC_DIR --strip-components=1 || err 10
fi


#
# gcc
#

URL=$GCC_URL
SRC_DIR=$SOURCES/gcc
if [[ ! -d $SRC_DIR ]]; then
  mkdir -p $SRC_DIR                                         &&
  curl -L $URL | tar xzf - -C $SRC_DIR --strip-components=1 &&
  (
    cd $SRC_DIR

    # Patch GCC to work with musl
    curl -L https://raw.githubusercontent.com/GregorR/musl-cross/master/patches/gcc-$GCC_VERSION-musl.diff | patch --silent -Np1 || exit 20

    # Download source code of mpfr, gmp & mpc
#    contrib/download_prerequisites
    mkdir -p mpfr && curl -L http://ftpmirror.gnu.org/mpfr/mpfr-3.1.2.tar.bz2 | tar xjf - -C mpfr --strip-components=1 &&
    mkdir -p gmp  && curl -L http://ftpmirror.gnu.org/gmp/gmp-6.0.0a.tar.bz2  | tar xjf - -C gmp  --strip-components=1 &&
    mkdir -p mpc  && curl -L http://ftpmirror.gnu.org/mpc/mpc-1.0.2.tar.gz    | tar xzf - -C mpc  --strip-components=1 || exit 21
  ) || err $?
fi


#
# Linux kernel headers
#

URL=$LINUX_URL
SRC_DIR=$SOURCES/linux
if [[ ! -d $SRC_DIR ]]; then
  mkdir -p $SRC_DIR                                         &&
  curl -L $URL | tar xzf - -C $SRC_DIR --strip-components=1 || err 30
fi


#
# musl
#

URL=$MUSL_URL
SRC_DIR=$SOURCES/musl
if [[ ! -d $SRC_DIR ]]; then
  mkdir -p $SRC_DIR                                         &&
  curl -L $URL | tar xzf - -C $SRC_DIR --strip-components=1 || err 40
fi


# Check system headers
if [[ ! -r /usr/include/rpc/types.h ]]; then
  su -c 'mkdir -pv /usr/include/rpc'
  su -c 'cp -v sunrpc/rpc/*.h /usr/include/rpc'
fi
