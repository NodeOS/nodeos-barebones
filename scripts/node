#!/usr/bin/env node

var readlinkSync = require('fs').readlinkSync


var cpu = process.argv[2] || readlinkSync('out/latest').split('/')[-2]

var cpu_family;
switch(cpu)
{
  case 'armv6':
    cpu_family = 'arm'
  break

  case 'i386':
  case 'i486':
  case 'i586':
  case 'i686':
  case 'i786':
    cpu_family = 'i386'
  break

  case 'nocona':
  case 'x86_64':
    cpu_family = 'x86_64'
  break

  default:
    console.error('Unknown cpu:',cpu)
    process.exit(-1)
}


// [Hack] Can't be able to use x86_64 as generic x86 64 bits CPU
var toolchainCpu = (cpu === 'nocona') ? 'x86_64' : cpu

const LD_LIBRARY_PATH = 'node_modules/nodeos-cross-toolchain/out/'+toolchainCpu+'-nodeos-linux-musl/lib'

process.env.LD_LIBRARY_PATH = LD_LIBRARY_PATH
var command = 'qemu-'+cpu_family
var args = [LD_LIBRARY_PATH+'/libc.so', 'obj/'+cpu+'/node', '--interactive']

spawn(command, args)
