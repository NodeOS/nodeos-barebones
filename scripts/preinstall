#!/usr/bin/env node

var cp   = require('child_process')
var cpus = require('os').cpus
var fs   = require('fs')
var path = require('path')

var manager = require('download-manager')


const JOBS = cpus().length


var targetList =
[
  'arm-softmmu',
  'i386-softmmu',
  'x86_64-softmmu',
  'arm-linux-user',
  'i386-linux-user',
  'x86_64-linux-user'
]


// Source versions

const INIT_VERSION   = "master"
const LINUX_VERSION  = "4.5"
const NODEJS_VERSION = "v4.4.2"


// Source URLs

const INIT_URL   = "https://github.com/piranna/nodeos-init/archive/"+INIT_VERSION+".tar.gz"
const LINUX_URL  = "https://www.kernel.org/pub/linux/kernel/v4.x/linux-"+LINUX_VERSION+".tar.gz"
const NODEJS_URL = "http://nodejs.org/dist/"+NODEJS_VERSION+"/node-"+NODEJS_VERSION+".tar.gz"


// Checksums

const LINUX_SHA256  = '2011b1dbb8c9a5c89279984657b7bb0fd58fdf94c5bdff100cc9f25351e948d8'
const NODEJS_SHA256 = 'ae91cb0a31f87b5b13bb2665178845d99abf1037dc3636fa88f442b4a4c65297'


// Patche Linux kernel to add Unicode BMP support on `fbcon`
const LINUX_CJKTTY_VERSION = "4.4"
const LINUX_CJKTTY_PATCH = "https://raw.githubusercontent.com/NodeOS/cjktty-patch/master/patches/linux-"+LINUX_CJKTTY_VERSION+"-cjktty.diff"


//
// Node.js
//

var downloads =
[
  {
    name: 'init',
    url: INIT_URL
  },
  {
    name: 'linux',
    url: LINUX_URL,
    sha256: LINUX_SHA256,
    patch:
    [
      {
        url: LINUX_CJKTTY_PATCH,
        strip: 1
      },
      {
        url: 'resources/linux-vagrant.patch',
        strip: 1
      }
    ]
  },
  {
    name: 'node',
    url: NODEJS_URL,
    sha256: NODEJS_SHA256,
    action: function(callback)
    {
      // Allow to inspect NodeOS version from inside Node.js
      try
      {
        var version = require('../../../package.json').version
      }
      catch(e)
      {
        var version = '(unknown)'
      }
      var data = "exports.nodeos = '"+version+"'"

      fs.appendFile(path.join('deps', this.name, 'lib/os.js'), data, callback)
    }
  }
]


manager(downloads, function(error)
{
  if(error)
  {
    console.trace(error)
    process.exit(1)
  }
})
